<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Messenger</title>
  <style>
    :root {
      --primary-color: #3a86ff;
      --secondary-color: #8338ec;
      --light-bg: #f7f7f7;
      --dark-bg: #333;
      --text-color: #333;
      --light-text: #f7f7f7;
      --border-radius: 8px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-bg);
      color: var(--text-color);
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    /* Header styles */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    /* Player styles */
    .player-container {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .now-playing {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .now-playing-info {
      flex-grow: 1;
    }

    .song-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .artist-name {
      color: #666;
      font-size: 0.9rem;
    }

    .controls {
      margin-top: 15px;
    }

    .progress-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .seek-bar {
      flex-grow: 1;
      height: 5px;
      -webkit-appearance: none;
      appearance: none;
      background: #ddd;
      border-radius: 5px;
      outline: none;
    }

    .seek-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 15px;
      height: 15px;
      background: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
    }

    .time-display {
      font-size: 0.8rem;
      color: #666;
      min-width: 80px;
      text-align: right;
    }

    /* Chat styles */
    .chat-container {
      height: 300px;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
    }

    .user-message {
      align-self: flex-end;
      background-color: var(--primary-color);
      color: white;
      border-bottom-right-radius: 5px;
    }

    .assistant-message {
      align-self: flex-start;
      background-color: #e9e9eb;
      color: var(--text-color);
      border-bottom-left-radius: 5px;
    }

    .message-sender {
      font-size: 0.8rem;
      margin-bottom: 5px;
      opacity: 0.7;
    }

    /* Input styles */
    .input-container {
      display: flex;
      padding: 10px 15px;
      background-color: white;
      border-top: 1px solid #eee;
    }

    .chat-input {
      flex-grow: 1;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 10px 15px;
      outline: none;
      font-size: 1rem;
    }

    .chat-input:focus {
      border-color: var(--primary-color);
    }

    .send-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-left: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .send-button:hover {
      background-color: var(--secondary-color);
    }

    .send-button i {
      font-size: 1.2rem;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
    }

    .suggestion-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 15px;
      padding: 5px 10px;
      margin-right: 5px;
      margin-bottom: 5px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-block;
    }

    .suggestion-button:hover {
      background-color: #e0e0e0;
    }

    /* Status indicators */
    .status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      margin-left: 10px;
    }

    .status-playing {
      background-color: #4CAF50;
      color: white;
    }

    .status-paused {
      background-color: #FFC107;
      color: black;
    }

    /* Hidden YouTube player */
    #player {
      position: absolute;
      top: -9999px;
      left: -9999px;
      width: 0;
      height: 0;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 0 10px;
        margin: 10px auto;
      }

      .chat-container {
        height: 250px;
      }
    }

    /* Add some Google Material Icons for buttons */
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      display: inline-block;
      line-height: 1;
      text-transform: none;
      letter-spacing: normal;
      word-wrap: normal;
      white-space: nowrap;
      direction: ltr;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      -moz-osx-font-smoothing: grayscale;
      font-feature-settings: 'liga';
    }
  </style>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="card">
      <!-- Header -->
      <div class="header">
        <h1>Music Messenger</h1>
        <div id="player-status"></div>
      </div>

      <!-- Player Section -->
      <div class="player-container">
        <div class="now-playing">
          <div class="now-playing-info">
            <div id="song-title" class="song-title">No song playing</div>
            <div id="artist-name" class="artist-name">-</div>
          </div>
          <button id="play-pause-btn" class="btn btn-primary" onclick="togglePlayPause()" disabled>
            <i class="material-icons">play_arrow</i>
          </button>
        </div>

        <div class="controls">
          <div class="progress-container">
            <input type="range" id="seek-bar" class="seek-bar" value="0" min="0" max="100" step="1" disabled>
            <span id="time-display" class="time-display">0:00 / 0:00</span>
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <div id="chat-container" class="chat-container">
        <div class="message assistant-message">
          <div class="message-content">
            Hi! I'm your music assistant. Ask me to play a song or tell me what kind of music you're in the mood for.
          </div>
        </div>
      </div>

      <!-- Song Suggestions (optional) -->
      <div id="suggestions-container" style="padding: 0 15px 10px;">
        <div id="suggestions"></div>
      </div>

      <!-- Input Section -->
      <div class="input-container">
        <input id="chat-input" class="chat-input" type="text" placeholder="Ask for a song or just chat..."
               onkeypress="if(event.key === 'Enter') sendChatMessage()">
        <button id="chat-send-btn" class="send-button" onclick="sendChatMessage()">
          <i class="material-icons">send</i>
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden YouTube Player -->
  <div id="player"></div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // Global variables
    let player;
    let updateTimer;
    let isPlaying = false;
    let chatHistory = "";
    let currentSong = "";
    let currentArtist = "";

    // Sample suggestions to start with
    const initialSuggestions = [
      "Play something upbeat",
      "I'm feeling nostalgic",
      "Play some rock music"
    ];

    // Initialize YouTube Player
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        videoId: '',
        playerVars: {
          'autoplay': 0,
          'controls': 0,
          'disablekb': 1,
          'modestbranding': 1,
          'rel': 0,
          'origin': window.location.origin
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      console.log('Player is ready.');
      updatePlayerControls();
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        document.getElementById("play-pause-btn").innerHTML = '<i class="material-icons">pause</i>';
        document.getElementById("player-status").innerHTML = '<span class="status status-playing">Playing</span>';
        startUpdating();
      } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        document.getElementById("play-pause-btn").innerHTML = '<i class="material-icons">play_arrow</i>';
        document.getElementById("player-status").innerHTML = '<span class="status status-paused">Paused</span>';
        stopUpdating();
      } else if (event.data === YT.PlayerState.ENDED) {
        isPlaying = false;
        document.getElementById("play-pause-btn").innerHTML = '<i class="material-icons">replay</i>';
        document.getElementById("player-status").innerHTML = '';
        stopUpdating();
      }
    }

    // Player control functions
    function startUpdating() {
      updateTimer = setInterval(updateSeekBar, 500);
    }

    function stopUpdating() {
      clearInterval(updateTimer);
    }

    function updateSeekBar() {
      if (player && player.getDuration) {
        const duration = player.getDuration();
        const currentTime = player.getCurrentTime();
        const seekBar = document.getElementById("seek-bar");
        seekBar.max = duration;
        seekBar.value = currentTime;
        document.getElementById("time-display").innerText =
          formatTime(currentTime) + " / " + formatTime(duration);
      }
    }

    function formatTime(time) {
      time = Math.floor(time);
      const minutes = Math.floor(time / 60);
      let seconds = time % 60;
      if (seconds < 10) seconds = "0" + seconds;
      return minutes + ":" + seconds;
    }

    function togglePlayPause() {
      if (!player) return;

      if (isPlaying) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    }

    // Update player controls state
    function updatePlayerControls(enabled = false) {
      const playPauseBtn = document.getElementById("play-pause-btn");
      const seekBar = document.getElementById("seek-bar");

      playPauseBtn.disabled = !enabled;
      seekBar.disabled = !enabled;

      if (!enabled) {
        document.getElementById("player-status").innerHTML = '';
      }
    }

    // Seek bar event listener
    document.getElementById("seek-bar").addEventListener("input", function() {
      if (player && player.seekTo) {
        player.seekTo(parseFloat(this.value), true);
      }
    });

    // Chat and music integration functions
    async function sendChatMessage() {
      const chatInput = document.getElementById("chat-input");
      const message = chatInput.value.trim();

      if (!message) return;

      // Add user message to chat
      addChatMessage("You", message, true);

      // Keep a more structured chat history with timestamps
      const timestamp = new Date().toLocaleTimeString();
      chatHistory += `[${timestamp}] You: ${message}\n`;

      // Clear input
      chatInput.value = "";

      try {
        // Show typing indicator
        showTypingIndicator();

        // Send to chat endpoint with the full chat history
        const response = await fetch("http://127.0.0.1:5000/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: message,
            chat_history: chatHistory
          })
        });

        // Hide typing indicator
        hideTypingIndicator();

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const result = await response.json();
        console.log("Chat Response:", result);

        if (result.reply) {
          // Add assistant message to chat
          addChatMessage("Assistant", result.reply, false);

          // Add to chat history with timestamp
          const timestamp = new Date().toLocaleTimeString();
          chatHistory += `[${timestamp}] Assistant: ${result.reply}\n`;

          // Check if there's a play command
          if (result.play_command) {
            playSongFromCommand(result.play_command.song, result.play_command.artist);
          }
        } else {
          addChatMessage("Assistant", "Sorry, something went wrong.", false);
        }
      } catch (error) {
        console.error("Chat Error:", error);
        hideTypingIndicator();
        addChatMessage("Assistant", "Failed to connect to chat service.", false);
      }
    }

    // Handle playing song directly from AI's suggestion
    function playSongFromCommand(songTitle, artistName) {
      if (!songTitle) return;

      if (artistName === "Unknown") {
        addSystemMessage(`Searching for "${songTitle}"...`);
        searchAndPlay(songTitle);
      } else {
        addSystemMessage(`Playing "${songTitle}" by ${artistName}...`);
        playSong(songTitle, artistName);
      }
    }

    // Search for a term and play the first result
    async function searchAndPlay(searchTerm) {
      if (!searchTerm) return;

      try {
        const response = await fetch("http://127.0.0.1:5000/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ search_term: searchTerm })
        });

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Search Response:", data);

        if (data.url) {
          const url = new URL(data.url);
          const videoId = url.searchParams.get("v");

          if (player && videoId) {
            // Update current song info
            currentSong = data.title || searchTerm;
            currentArtist = data.artist || "Unknown Artist";

            // Update display
            document.getElementById("song-title").textContent = currentSong;
            document.getElementById("artist-name").textContent = currentArtist;

            // Enable controls and play video
            updatePlayerControls(true);
            player.loadVideoById(videoId);

            addSystemMessage(`Found and playing "${currentSong}" by ${currentArtist}`);
          } else {
            addSystemMessage("Video ID not found");
          }
        } else {
          addSystemMessage(data.error || "An error occurred while searching");
        }
      } catch (error) {
        console.error("Search Error:", error);
        addSystemMessage("Failed to connect to the music service");
      }
    }

    // Play AI function (separate from chat)
    async function playAi() {
      try {
        // Show typing indicator
        showTypingIndicator();

        // Send previous chat history to the /play_ai endpoint
        const response = await fetch("http://127.0.0.1:5000/play_ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_history: chatHistory })
        });

        // Hide typing indicator
        hideTypingIndicator();

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const result = await response.json();
        console.log("Play AI Response:", result);

        if (result.song && result.artist) {
          const song = result.song;
          const artist = result.artist;

          addSystemMessage(`AI suggests playing "${song}" by ${artist}`);
          playSong(song, artist);
        } else {
          addSystemMessage("AI couldn't suggest a song.");
        }
      } catch (error) {
        console.error("Play AI Error:", error);
        hideTypingIndicator();
        addSystemMessage("Failed to connect to the AI service.");
      }
    }

    // Main function to play songs
    async function playSong(songTitle, artistName) {
      if (!songTitle && !artistName) {
        console.error("Either song title or artist name is required");
        return;
      }

      try {
        // Create payload based on what we have
        let payload = {};

        if (songTitle && artistName) {
          payload = { song_title: songTitle, artist_name: artistName };
        } else if (songTitle) {
          payload = { song_title: songTitle };
        } else if (artistName) {
          payload = { artist_name: artistName, song_title: "popular song" };
        }

        const response = await fetch("http://127.0.0.1:5000/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Search Response:", data);

        if (data.url) {
          const url = new URL(data.url);
          const videoId = url.searchParams.get("v");

          if (player && videoId) {
            // Update current song info
            currentSong = data.title || songTitle;
            currentArtist = data.artist || artistName;

            // Update display
            document.getElementById("song-title").textContent = currentSong;
            document.getElementById("artist-name").textContent = currentArtist;

            // Enable controls and play video
            updatePlayerControls(true);
            player.loadVideoById(videoId);
          } else {
            addSystemMessage("Video ID not found");
          }
        } else {
          addSystemMessage(data.error || "An error occurred while searching for the song");
        }
      } catch (error) {
        console.error("Search Error:", error);
        addSystemMessage("Failed to connect to the music service");
      }
    }

    // Chat UI functions
    function addChatMessage(sender, message, isUser = false) {
      const container = document.getElementById("chat-container");
      const messageElem = document.createElement("div");

      messageElem.className = isUser ? "message user-message" : "message assistant-message";

      const messageContent = document.createElement("div");
      messageContent.className = "message-content";
      messageContent.textContent = message;

      messageElem.appendChild(messageContent);
      container.appendChild(messageElem);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;

      // Update suggestions based on assistant messages
      if (!isUser && message.length > 20) {
        updateSuggestions();
      }
    }

    function addSystemMessage(message) {
      const container = document.getElementById("chat-container");
      const messageElem = document.createElement("div");

      messageElem.className = "message assistant-message";
      messageElem.style.backgroundColor = "#f0f0f0";
      messageElem.style.fontStyle = "italic";
      messageElem.style.fontSize = "0.9rem";

      const messageContent = document.createElement("div");
      messageContent.className = "message-content";
      messageContent.textContent = message;

      messageElem.appendChild(messageContent);
      container.appendChild(messageElem);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    // Typing indicator
    function showTypingIndicator() {
      const container = document.getElementById("chat-container");
      const typingElem = document.createElement("div");
      typingElem.id = "typing-indicator";
      typingElem.className = "message assistant-message";
      typingElem.style.padding = "8px 15px";

      const typingDots = document.createElement("div");
      typingDots.innerHTML = "Thinking<span class='dot'>.</span><span class='dot'>.</span><span class='dot'>.</span>";
      typingDots.style.fontSize = "0.9rem";

      // Add animation for dots
      const style = document.createElement("style");
      style.textContent = `
        @keyframes blink {
          0% { opacity: 0.2; }
          20% { opacity: 1; }
          100% { opacity: the.2; }
        }
        #typing-indicator .dot {
          animation: blink 1.4s infinite;
          animation-fill-mode: both;
        }
        #typing-indicator .dot:nth-child(2) {
          animation-delay: 0.2s;
        }
        #typing-indicator .dot:nth-child(3) {
          animation-delay: 0.4s;
        }
      `;
      document.head.appendChild(style);

      typingElem.appendChild(typingDots);
      container.appendChild(typingElem);

      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingElem = document.getElementById("typing-indicator");
      if (typingElem) {
        typingElem.remove();
      }
    }

    // Generate and update song suggestions
    function updateSuggestions() {
      // For simplicity, this just uses the initial suggestions
      // In a real app, you might want to generate these dynamically based on chat history
      displaySuggestions(initialSuggestions);
    }

    function displaySuggestions(suggestions) {
      const container = document.getElementById("suggestions");
      container.innerHTML = "";

      if (!suggestions || suggestions.length === 0) return;

      suggestions.forEach(suggestion => {
        const button = document.createElement("button");
        button.className = "suggestion-button";
        button.textContent = suggestion;
        button.onclick = () => {
          document.getElementById("chat-input").value = suggestion;
          sendChatMessage();
        };
        container.appendChild(button);
      });
    }

    // Initialize the app
    window.onload = function() {
      // Display initial suggestions
      displaySuggestions(initialSuggestions);

      // Focus on chat input
      document.getElementById("chat-input").focus();
    };
  </script>
</body>
</html>